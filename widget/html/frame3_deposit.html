<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>会员中心</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../css/style.css"/>
    <style>
          body{ background-color: #efefef}
          .empty{ text-align: center; padding: 120px 0; }
	        .container{ margin: auto 15px;}
          .header{height: 60px;text-align: center;padding-top: 60px;}

          .weui-cells__title+.weui-cells {
            margin-top: 0;
          }

          .weui-cells {
            margin-top: 8px;
            background-color: #FFFFFF;
            line-height: 1.41176471;
            font-size: 17px;
            overflow: hidden;
            position: relative;
          }

          .weui-cells:before {
            content: " ";
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            height: 1px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.1);
            -webkit-transform-origin: 0 0;
            transform-origin: 0 0;
            -webkit-transform: scaleY(0.5);
            transform: scaleY(0.5);
            z-index: 2;
          }

          .weui-cells:after {
            content: " ";
            position: absolute;
            left: 0;
            bottom: 0;
            right: 0;
            height: 1px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.1);
            -webkit-transform-origin: 0 100%;
            transform-origin: 0 100%;
            -webkit-transform: scaleY(0.5);
            transform: scaleY(0.5);
            z-index: 2;
          }

          .weui-cell {
            padding: 16px;
            position: relative;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
          }

          .weui-cell:before {
            content: " ";
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            height: 1px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.1);
            -webkit-transform-origin: 0 0;
            transform-origin: 0 0;
            -webkit-transform: scaleY(0.5);
            transform: scaleY(0.5);
            left: 16px;
            z-index: 2;
          }

          .weui-label {
            display: block;
            width: 105px;
            word-wrap: break-word;
            word-break: break-all;
          }

          .weui-cells_form input,
          .weui-cells_form textarea,
          .weui-cells_form label[for] {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          }

          .weui-input {
            width: 100%;
            border: 0;
            outline: 0;
            -webkit-appearance: none;
            background-color: transparent;
            font-size: inherit;
            color: inherit;
            height: 1.41176471em;
            line-height: 1.41176471;
          }

          input {
            -webkit-appearance: textfield;
            background-color: white;
            -webkit-rtl-ordering: logical;
            cursor: text;
            padding: 1px;
            border-width: 2px;
            border-style: inset;
            border-color: initial;
            border-image: initial;
          }

          input,
          textarea,
          select,
          button {
            text-rendering: auto;
            color: initial;
            letter-spacing: normal;
            word-spacing: normal;
            text-transform: none;
            text-indent: 0px;
            text-shadow: none;
            display: inline-block;
            text-align: start;
            margin: 0em;
            font: 400 13.3333px Arial;
          }

          .weui-btn-area {
            margin: 20px 16px 8px;
          }

          .weui-btn_primary {
            background-color: #07C160;
          }

          .weui-btn {
            position: relative;
            display: block;
            width: 184px;
            margin-left: auto;
            margin-right: auto;
            padding: 8px 24px;
            box-sizing: border-box;
            font-weight: 700;
            font-size: 17px;
            text-align: center;
            text-decoration: none;
            color: #FFFFFF;
            line-height: 1.41176471;
            border-radius: 4px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            overflow: hidden;
          }

          .weui-btn_primary:not(.weui-btn_disabled):visited {
            color: #FFFFFF;
          }

          .weui-btn_default {
            background-color: #f2f2f2;
            color: #000;
          }

    </style>
</head>
<body>
    <div class="container">
      <div class="header">
        会员充值
      </div>
      <div class="weui-cells weui-cells_form">
				<!-- <div class="weui-cell">
					<div class="weui-cell__hd">
						<label class="weui-label">手机号：</label>
					</div>
					<div class="weui-cell__bd">
						<input id="username" class="weui-input" type="number" name="username" value="" placeholder="请输入手机号" />
					</div>
				</div> -->
				<div class="weui-cell" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
					<div class="weui-cell__hd">
						<label class="weui-label">充值码</label>
					</div>
					<div class="weui-cell__bd">
						<input id="secret" class="weui-input" type="text" name="secret" value="" placeholder="请输入充值码" />
					</div>
				</div>
				<div class="weui-btn-area">
					<button class="weui-btn weui-btn_primary" type="button" name="button" onclick="btnScrete();">确认充值</button>
				</div>
				<div class="weui-btn-area">
					<button class="weui-btn weui-btn_default" type="button" name="button" onclick="btnReturn();">返回</button>
				</div>
			</div>
    </div>
</body>
</html>
<script type="text/javascript" src="./../script/api.js"></script>
<script type="text/javascript" src="./../script/util.js"></script>
<script type="text/javascript" src="./../script/APICloud-rest.js"></script>
<script type="text/javascript">
  var userId = "";
  apiready = function () {
    userId = api.getPrefs({
        sync: true,
        key: 'userId'
    });
    api.addEventListener({
        name:'navitembtn'
    },function(ret, err){
        console.log($api.jsonToStr(ret))
        api.closeWin();
    });
  }

  function btnScrete() {
    // var username = $api.val($api.byId('username'));
    var secret = $api.val($api.byId('secret'));
    // if(!username) {
    //   api.toast({
    //       msg: '亲，请输入账号/手机号',
    //       duration: 2000,
    //       location: 'center'
    //   });
    //   return;
    // }
    if(!secret) {
      api.toast({
          msg: '亲，请输入充值码',
          duration: 2000,
          location: 'center'
      });
      return;
    }
    api.showProgress({
		    title: '努力充值中...',
		    text: '先喝杯茶...'
		});
    getModel("secret").query({
        filter:{
            "where":{"secret":secret}
        }
    }, function(ret,err){
      api.hideProgress();
      console.log("secret对象：" + $api.jsonToStr(ret))
      console.log("secret对象：" + $api.jsonToStr(err))
      if(ret && ret[0]&& ret[0].id){// 存在此充值码
        if(ret[0].userId && ret[0].userId !="" && ret[0].userId != null) {
          api.toast({
              msg: '亲，此充值码已使用',
              duration: 2000,
              location: 'top'
          });
        } else {
          //使用此充值码，更新此充值码已使用
          updateDposit(ret[0].id, ret[0].day);
        }
      } else { //不存在此充值码
        api.toast({
            msg: '亲，请输入正确的充值码',
            duration: 2000,
            location: 'top'
        });
      }
    })
  }

  //使用此充值码，更新此充值码已使用
  function updateDposit(id, day) {
    api.showProgress({
        title: '努力充值中...',
        text: '先喝杯茶...'
    });
    getModel("user").query({
        filter:{
            "where":{"_id": userId}
        }
    }, function(ret1, err1){
      api.hideProgress();
      console.log("用户对象：" + $api.jsonToStr(ret1))
      console.log("用户对象：" + $api.jsonToStr(err1))
      if(ret1 && ret1[0] && ret1[0].id){ //输入的账户存在，更新账户状态，获得vip
        api.showProgress({
            title: '努力充值中...',
            text: '先喝杯茶...'
        });
        getModel("secret").save({"_id": id},{"userId": ret1[0].id}, function(ret2,err2){ // 更新用户状态
          api.hideProgress();
          console.log("保存后secret对象：" + $api.jsonToStr(ret2))
          console.log("保存后secret对象：" + $api.jsonToStr(err2))
            if(ret2 && ret2.id){
              //更改此会员的状态
              updateUserType(ret1[0].id, day, ret2.updatedAt, ret1[0].expireDate);
            } else{
              api.toast({
                  msg: '亲，充值码状态更新失败！',
                  duration: 2000,
                  location: 'top'
              });
            }
        })
      } else { // 输入账户不存在
        api.toast({
            msg: '亲，请输入正确的手机号',
            duration: 2000,
            location: 'top'
        });
      }
    });
  }
  //更改此会员的状态 expireDate (过期时间)
  function updateUserType(id, day, updatedAt, userExpireDate) {
    var currentSysDate = new Date(updatedAt); //当前服务器时间
    if(userExpireDate) { //判断用户是否充值过会员的时间
      console.log("userExpireDate: " + userExpireDate)
      var userExpireDateTemp = new Date(userExpireDate); //用户充值会员的过期时间
      console.log("userExpireDateTemp: " + userExpireDateTemp)
      if(currentSysDate < userExpireDateTemp) {// 判断用户会员是否过期
        //未过期
        userExpireDateTemp.setDate(userExpireDateTemp.getDate() + parseInt(day));
        console.log("userExpireDateTemp: " + userExpireDateTemp)
        updateUserTypePost(id, userExpireDateTemp)
      } else {
        //过期
        console.log("updateDate: " + currentSysDate)
        currentSysDate.setDate(currentSysDate.getDate() + parseInt(day));
        console.log("updateDate: " + currentSysDate)
        updateUserTypePost(id, currentSysDate)
      }
    }
  }

  function updateUserTypePost(id, expireDate) {
    getModel("user").save({"_id":id},{"expireDate": expireDate}, function(ret,err){
        console.log("更新后用户对象：" + $api.jsonToStr(ret))
        console.log("更新后用户对象：" + $api.jsonToStr(err))
        if(ret && ret.id){ //输入的账户存在，更新账户状态，获得vip
          api.toast({
              msg: '亲，！充值成功',
              duration: 2000,
              location: 'top'
          });
          api.closeWin();
          api.execScript({
              name: 'root',
              frameName: 'frame2',
              script: 'reloadFrame();'
          });
        }else{
          api.toast({
              msg: '亲，！充值失败，请重试',
              duration: 2000,
              location: 'top'
          });
        }
    })
  }

  function btnReturn() {
    api.closeWin();
  }
</script>
