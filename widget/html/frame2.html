<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>会员中心</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../css/style.css"/>
    <style>
          body{ background-color: #efefef}
          .empty{ text-align: center; padding: 120px 0; }
		      .container{ margin: auto 15px;}
          .header ul.flex-wrap li{ padding-top: 40px; padding-bottom: 23px; background: url() no-repeat center 31px; background-size: auto 44px; text-align: center; }
          .header ul.flex-wrap li:nth-child(1){width: 20%;background-image: url(./../image/mangguo.png);}
          .header ul.flex-wrap li .flex-item-div{ text-align: left; }
          .header ul.flex-wrap li .flex-vip-con{ padding-left: 30px;background: url() no-repeat left -8px; background-image: url(./../image/vipx.png);background-size: 26px 26px;}
          .header .no-loged{padding: 30px 12px;height: 37px}

          .content ul.flex-wrap-list li{padding: 20px 15px; border-bottom: 1px solid #e5e5e5}
          .content ul.flex-wrap-list li:nth-child(6){border-bottom:0px}
          .content {background-color: #f9f9f9; border-radius: 1em; -moz-box-shadow: 4px 6px 15px #bcbcbc; /* 老的 Firefox */box-shadow: 4px 6px 15px #bcbcbc;}
          .item-hide{display: none;}
    </style>
</head>
<body>
    <div class="container">
      <div class="header">
        <div class="has-loged">
          <ul class="flex-wrap">
            <li class="flex-item"></li>
            <li class="flex-item"><div id="divUsername" class="flex-item-div">未知</div><div id="divExpireDate" class="flex-con-div flex-vip-con">您还不是vip</div></li>
          </ul>
        </div>
        <div class="no-loged item-hide">
          您还未登录
        </div>
      </div>
      <div class="content">
        <ul class="flex-wrap-list">
          <li id="quiteSelect" class="flex-item has-loged" onclick="quit()">安全退出</li>
          <li class="flex-item" onclick="deposit()">会员充值</li>
          <li class="flex-item" onclick="registe()">用户注册</li>
          <li class="flex-item" onclick="modifyMM()">修改密码</li>
          <li class="flex-item" onclick="contactMe()">联系客服</li>
          <li class="flex-item" onclick="aboutMe()">关于我们</li>
        </ul>
      </div>
    </div>
</body>
</html>
<script type="text/javascript" src="./../script/api.js"></script>
<script type="text/javascript" src="./../script/util.js"></script>
<script type="text/javascript" src="./../script/common.js"></script>
<script type="text/javascript" src="./../script/APICloud-rest.js"></script>
<script type="text/javascript">
  var accessToken = "";
  apiready = function () {
    console.log("winName: " +api.winName)
    console.log("frameName: " +api.frameName)

    //同步返回结果：
    accessToken = api.getPrefs({
        sync: true,
        key: 'accessToken'
    });
    // 获取用户vip状态
    getUserVipType({
      callback: function(ret) {
        $api.text($api.dom('#divUsername'), ret.username); //显示用户名
        if(ret.expireDate && ret.expireDate != '' && ret.expireDate != null) { //该用户有会员状态
            var userExpireDateTemp = new Date(ret.expireDate); //用户充值会员的过期时间
            var currentSysDate = new Date(ret.updatedAt); //用户充值会员的过期时间
            if(currentSysDate < userExpireDateTemp) { //会员状态还在 您还不是vip
              $api.text($api.dom('#divExpireDate'), "截止" + formatTimeYMD(userExpireDateTemp));
            } else { //会员过期
              $api.text($api.dom('#divExpireDate'), '亲！您的vip已过期');
            }
        } else { // 该用户还不是会员
          $api.text($api.dom('#divExpireDate'), '亲！您还不是vip');
        }
      }
    });

    console.log("token: ###  " + accessToken);
    if(accessToken && accessToken != "" && accessToken != null) {
      $api.addCls($api.dom('#quiteSelect'), 'has-loged') // 给登录按钮添加已经登录的标识
      $api.text($api.dom('#quiteSelect'), '安全退出'); // 改变按钮文字为“安全退出”
      $api.addCls($api.dom('#quiteSelect'), 'has-loged')
    } else {
      $api.addCls($api.dom('.has-loged'), 'item-hide')
      $api.removeCls($api.dom('.no-loged'), 'item-hide');
      $api.removeCls($api.dom('#quiteSelect'), 'has-loged');
      $api.text($api.dom('#quiteSelect'), '立即登录');
    }
  }
  //会员充值按钮点击事件
  function deposit() {
    api.getPrefs({
        key: 'accessToken'
    }, function(ret, err) {
        accessToken = ret.value;
        if(accessToken && accessToken != "" && accessToken != null) {
          // 打开只有navigationBar的页面：
          api.openTabLayout({
              name: 'navDeposit',
              url: 'widget://html/frame2_deposit.html',
              title: '会员充值',
              hideNavigationBar: false,
              navigationBar: {
                  background: '#f2f2f2',
                  leftButtons: [{
                      iconPath: 'widget://image/left.png'
                  }]
              }
          });
        } else { //未登录处理逻辑
          api.toast({
              msg: '亲，会员充值需要先登录哦!',
              duration: 2000,
              location: 'top'
          });
        }
    });

  }
  //注册按钮点击事件
  function registe() {
    // 打开只有navigationBar的页面：
    api.openTabLayout({
        name: 'navRegiste',
        url: 'widget://html/frame2_registe.html',
        title: '注册会员',
        hideNavigationBar: false,
        navigationBar: {
            background: '#f2f2f2',
            leftButtons: [{
                iconPath: 'widget://image/left.png'
            }]
        }
    });
  }

  //安全退出按钮点击事件
  function quit() {
    if($api.hasCls($api.dom('#quiteSelect'), 'has-loged')) {
      $api.addCls($api.dom('.has-loged'), 'item-hide')
      $api.removeCls($api.dom('.no-loged'), 'item-hide');
      $api.removeCls($api.dom('#quiteSelect'), 'has-loged');
      $api.text($api.dom('#quiteSelect'), '立即登录');
      //移除本地用户缓存
      api.removePrefs({
          key: 'accessToken'
      });
      api.removePrefs({
          key: 'userId'
      });
    } else {
      // 打开只有navigationBar的页面：
      api.openTabLayout({
          name: 'navLogin',
          url: 'widget://html/frame2_login.html',
          title: '会员登陆',
          hideNavigationBar: false,
          navigationBar: {
              background: '#f2f2f2',
              leftButtons: [{
                  iconPath: 'widget://image/left.png',
                  fontSize: '14'
              }]
          }
      });
    }
  }
  //修改密码按钮点击事件
  function modifyMM() {
    if(!accessToken) {
      api.toast({
				msg: '亲，您还未登录，请先登录',
				duration: 2000,
				location: 'top'
			});
      return;
    }
    api.openTabLayout({
        name: 'navModifyMM',
        url: 'widget://html/frame2_modify_pass.html',
        title: '修改密码',
        hideNavigationBar: false,
        navigationBar: {
            background: '#f2f2f2',
            leftButtons: [{
                iconPath: 'widget://image/left.png',
                fontSize: '14'
            }]
        }
    });
  }
  //联系我们按钮点击事件
  function contactMe() {
    api.alert({
        title: '联系客服',
        msg: '客服微信：13717866249',
    }, function(ret, err) {

    });
  }

  //关于我们按钮点击事件
  function aboutMe() {
    api.openTabLayout({
        name: 'navAboutMe',
        url: 'widget://html/frame2_about.html',
        title: '关于我们',
        hideNavigationBar: false,
        navigationBar: {
            background: '#f2f2f2',
            leftButtons: [{
                iconPath: 'widget://image/left.png',
                fontSize: '14'
            }]
        }
    });
  }

  function reloadFrame() {
    // console.log("哈哈")
    api.setFrameGroupIndex({
        name: 'group',
        index: 2,
        reload: true
    });
  }

</script>
